from flask import Flask, request, jsonify
import sqlite3
import uuid
from datetime import datetime

app = Flask(__name__)

DB = "../database/messages.db"


# -----------------------------
# DATABASE SETUP
# -----------------------------
def init_db():
    conn = sqlite3.connect(DB)
    c = conn.cursor()

    c.execute("""
    CREATE TABLE IF NOT EXISTS messages(
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        messageId TEXT,
        messageText TEXT,
        timestamp TEXT,
        isDuplicate INTEGER
    )
    """)

    conn.commit()
    conn.close()


init_db()


# -----------------------------
# PRODUCER API
# -----------------------------
@app.route("/api/messages", methods=["POST"])
def publish_message():

    data = request.json
    message_text = data.get("messageText")

    message_id = str(uuid.uuid4())
    timestamp = datetime.utcnow().isoformat()

    process_message(message_id, message_text, timestamp)

    return jsonify({"status": "Message Published"})


# -----------------------------
# CONSUMER LOGIC
# -----------------------------
def process_message(message_id, message_text, timestamp):

    conn = sqlite3.connect(DB)
    c = conn.cursor()

    # Duplicate check
    c.execute(
        "SELECT * FROM messages WHERE messageId=?",
        (message_id,)
    )

    existing = c.fetchone()
    is_duplicate = 1 if existing else 0

    c.execute("""
        INSERT INTO messages(messageId,messageText,timestamp,isDuplicate)
        VALUES (?,?,?,?)
    """, (message_id, message_text, timestamp, is_duplicate))

    conn.commit()
    conn.close()


# -----------------------------
# VIEWER API
# -----------------------------
@app.route("/api/messages", methods=["GET"])
def get_messages():

    conn = sqlite3.connect(DB)
    c = conn.cursor()

    c.execute("""
        SELECT messageId,messageText,timestamp,isDuplicate
        FROM messages
    """)

    rows = c.fetchall()
    conn.close()

    result = []

    for r in rows:
        result.append({
            "messageId": r[0],
            "messageText": r[1],
            "timestamp": r[2],
            "isDuplicate": bool(r[3])
        })

    return jsonify(result)


if __name__ == "__main__":
    app.run(debug=True)
